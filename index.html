<!doctype html>
<html>
  <head>
    <title>MMO Pacman</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="960" height="640" style="position:absolute; left: 0px;">
    <script>
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      var items = [
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
      ];
      for (var i = 0; i < 30; i++){
        for (var j = 0; j < 20; j++){
          if (items[j][i] === 1){
            ctx.fillRect(32*i, 32*j, 32, 32);
          }
        }
      }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        var socket = io();
        var id = '';

        $(document).ready(function() {
          $(document).keydown(function(e) {
            if (e.which === 37) {
              socket.emit('left', 1);
            } else if (e.which === 38) {
              socket.emit('up', 1);
            } else if (e.which === 39) {
              socket.emit('right', 1);
            } else if (e.which === 40) {
              socket.emit('down', 1);
            }
          });

          $(document).keyup(function(e) {
            if (e.which === 37) {
              socket.emit('left', 0);
            } else if (e.which === 38) {
              socket.emit('up', 0);
            } else if (e.which === 39) {
              socket.emit('right', 0);
            } else if (e.which === 40) {
              socket.emit('down', 0);
            }
          });
        });

        socket.on('connect', function(){
          id = socket.io.engine.id;

          let playerType = "pacman";

          // TODO: Make this less random, maybe based on current score
          if (Math.random() > 0.7) {
            playerType = "ghost";
          }

          let img = document.createElement('img');
          img.src = playerType + ".png";
          img.id = id;
          img.width = 32;
          img.height = 32;
          img.style.position = "absolute";
          // TODO: Randomise start position, or maybe try to start in a safe location
          img.style.left = "200px";
          img.style.top = "200px";
          $('body')[0].appendChild(img);

          socket.emit('init', {"x": parseInt(img.style.left), "y": parseInt(img.style.top), "type": playerType});
        });

        socket.on('state', function(states){
          for (var key in states) {
            // TODO: check for special key for pellets and power pills, and make them visible/invisible using
            // img.style.visibility = ""/"hidden";
            if (states.hasOwnProperty(key)) {
              let state = states[key];

              if ($('#' + key)[0] === undefined) {
                let img = document.createElement('img');
                img.src = "other_" + state.type + ".png";
                img.id = key;
                img.width = 32;
                img.height = 32;
                img.style.position = "absolute";
                img.style.left = "200px";
                img.style.top = "200px";
                $('body')[0].appendChild(img);
              }

              $('#' + key)[0].style.left = state.x + ".px";
              $('#' + key)[0].style.top = state.y + ".px";

              if (state.type === "pacman") {
                $('#' + key)[0].style.transform = "rotate(" + state.angle + "deg)";
              } else if (state.type === "ghost") {
                if (state.angle >= 180) {
                  $('#' + key)[0].style.transform = "rotateY(180deg)";
                } else {
                  $('#' + key)[0].style.transform = "rotateY(0deg)";
                }
              }
            }
          }
        });

        // TODO: add socket.on function to delete img by id

        // TODO: add socket.on function to get the maze
        // TODO: draw the maze, probably by drawing each square that makes it up,
        // choosing an img src based on the position of walls. Players can be drawn
        // on top of these images providing they are ordered correctly

        // TODO: add ability to play music/sounds
      });
    </script>
    <!-- TODO: display scores -->
  </body>
</html>